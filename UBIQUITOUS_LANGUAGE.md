# ユビキタス言語（Ubiquitous Language）

このドキュメントは、re_spla_analysis プロジェクトにおけるドメイン駆動設計（DDD）のユビキタス言語を定義します。
開発チーム全員が共通の用語を使用し、ドメインモデルとコードを一致させることを目的としています。

## アプリケーション概要

Splatoonというゲームにおいて、勝敗を記録し、自身の得意ステージ、ルール、ブキ、時間帯などの傾向を探るための分析を行うアプリケーション。

---

## コアドメイン概念

### Match（試合）

**定義**: Splatoonにおける1回の対戦の記録

**属性**:

- `id`: 試合を一意に識別するUUID
- `result`: 勝敗（WIN/LOSEなど）
- `gameDatetime`: 試合が行われた日時
- `point`: 試合後のレートポイント（nullable）
- `weaponId`: 使用したブキのID
- `stageId`: 試合が行われたステージのID
- `ruleId`: 適用されたルールのID
- `battleTypeId`: 試合方式のID
- `userId`: プレイヤー（ユーザー）のID

**リレーション**:

- BattleType（試合方式）に所属
- Stage（ステージ）で実施
- Rule（ルール）で実施
- Weapon（ブキ）を使用
- User（ユーザー）が記録

**備考**:

- 旧名称は`Analysis`だったが、「分析」という行為と「試合記録」というデータを明確に区別するため`Match`に改名（2025-11-23実施済み）

---

### Weapon（ブキ）

**定義**: メインウェポン、サブウェポン、スペシャルウェポンの3つで構成される装備

**構成要素**:

- **メインウェポン（Weapon）**: プレイヤーが選択する主武器
- **サブウェポン（SubWeapon）**: メインウェポンに紐づくサブ武器（固定）
- **スペシャルウェポン（SpecialWeapon）**: メインウェポンに紐づく必殺技（固定）

**特性**:

- ユーザーによるカスタマイズ不可
- メインウェポンを選ぶと、サブとスペシャルは自動的に決定
- すべてマスターデータとして事前定義済み（seedデータ）

**データ例**:

```
メイン: わかばシューター
  └ サブ: スプラッシュボム
  └ スペシャル: グレートバリア
```

---

### BattleType（試合方式）

**定義**: Splatoonにおける対戦モードの種類

#### オープン

- **特性**: カジュアルなモード
- **レート変動**: 1試合ごとに±10程度の増減が確定
- **記録方法**: 各試合ごとにpointを記録

#### チャレンジ

- **特性**: レートがかかる真剣勝負
- **ルール**: 5勝または3敗で1セット完了
- **レート仕組み**:
  - セット参加時に170ポイント払う
  - 結果に応じてポイント獲得（例: 3勝3敗で約250獲得、差し引き+80）
  - 負けてもポイント自体は貰える
- **記録方法**: セット完了時にpointを記録（途中の試合はnullまたはユーザーが任意で記録可能）

#### Xマッチ

- **特性**: チャレンジの上位レート帯限定のシビアなレート戦
- **ルール**: 3勝または3敗で1セット完了
- **レート仕組み**:
  - 最低保証あり（レートに応じて変動）
  - 3連勝: 75, 25, 15ポイント程度（レート上昇に応じて最低保証は減少）
  - 3連敗: -75, -25, -15ポイント程度
- **記録方法**: セット完了時にpointを記録（途中の試合はnullまたはユーザーが任意で記録可能）

---

### Point（レートポイント）

**定義**: 試合終了後の累積レート（到達ポイント）

**記録タイミング**:

- **オープン**: 各試合ごとに記録
- **チャレンジ/Xマッチ**: セット完了時に記録（途中の試合はnullまたはユーザーが任意で記録可能）

**データ型**: Integer, Nullable

**Nullable理由**:

- 試合直後にレート変動が確定しないケースがある
- セット途中の試合では確定していない場合がある

**整合性**:

- ユーザーの責任で正しい累積レート値を入力
- 増減値ではなく、到達ポイント（絶対値）を記録

**記録例**:

```
オープン:
  試合1後: point = 1010（試合前1000 → +10）
  試合2後: point = 1005（試合前1010 → -5）

チャレンジ（5試合で1セット完了の例）:
  試合1: point = null（セット途中）
  試合2: point = null
  試合3: point = null
  試合4: point = null
  試合5: point = 1080（セット完了、確定したレート）
```

---

### Stage（ステージ）

**定義**: 試合が行われるマップ

**データ管理**: マスターデータ（seedに定義済み）

**ステージ一覧**（全23ステージ）:

- ユノハナ大渓谷
- ゴンズイ地区
- ヤガラ市場
- マテガイ放水路
- ナメロウ金属
- マサバ海峡大橋
- キンメダイ美術館
- マヒマヒリゾート&スパ
- 海女美術大学
- チョウザメ造船
- ザトウマーケット
- スメーシーワールド
- クサヤ温泉
- ヒラメが丘団地
- ナンプラー遺跡
- マンタマリア号
- オヒョウ海運
- タカアシ経済特区
- バイガイ亭
- ネギトロ炭鉱
- カジキ空港
- リュウグウターミナル
- デカライン高架下

---

### Rule（ルール）

**定義**: Splatoonのゲームルール

**データ管理**: マスターデータ（seedに定義済み）

**ルール一覧**（全4種類）:

- ガチエリア
- ガチヤグラ
- ガチホコバトル
- ガチアサリ

---

### User（ユーザー）

**定義**: アプリケーション利用者

**属性**:

- `id`: ユーザーを一意に識別するUUID
- `name`: ユーザー名
- `email`: メールアドレス（ユニーク）
- `createdAt`: 作成日時
- `updatedAt`: 更新日時
- `deletedAt`: 削除日時（論理削除、nullable）

**リレーション**:

- UserSecret（パスワード）を1対1で保持
- 複数のMatchを記録可能

---

### UserSecret（ユーザー認証情報）

**定義**: ユーザーのパスワードを保持するエンティティ

**属性**:

- `userId`: ユーザーID（主キー、外部キー）
- `password`: ハッシュ化されたパスワード

**用途**: ログイン認証のみ

**API設計**:

- CRUD APIは作成しない
- ログイン時の参照のみ実装

---

## 分析軸

ユーザーは以下の切り口で自身の試合傾向を分析できる：

1. **ステージ別勝率**: 各ステージごとの勝率を算出
2. **ルール別勝率**: 各ルールごとの勝率を算出
3. **ブキ別勝率**: 各ブキ（メインウェポン）ごとの勝率を算出
4. **時間帯別勝率**: `gameDatetime`から時間帯を抽出して勝率を算出
5. **試合方式別勝率**: オープン/チャレンジ/Xマッチごとの勝率を算出
6. **ステージ×ルールの組み合わせ別勝率**: 複合条件での勝率を算出
7. **レートポイントの推移**: 時系列でのレート変動をグラフ化

---

## データ入力方法

- **手動入力**: ユーザーが試合後に手動で結果を入力
- **API連携**: SplatoonのAPIは使用しない（現実的ではないため）

---

## 画面構成（予定）

### 認証系

- **ログイン画面**: ユーザー認証
- **新規登録画面**: ユーザーアカウント作成

### 試合記録管理

- **試合記録登録画面**: Matchの作成
- **試合記録一覧・検索画面**:
  - 検索条件: 日付範囲、ルール、ステージ、ブキ、勝敗、BattleType
- **試合記録編集画面**: 既存Matchの更新
- **試合記録削除画面**: Matchの削除

### 分析

- **ダッシュボード画面**: メイン分析画面（機能に応じて分割可能性あり）
  - 各種勝率の表示
  - レート推移グラフ
  - 得意/苦手な条件の可視化

### ユーザー管理

- **ユーザー情報参照画面**: 名前、email表示
- **ユーザー情報更新画面**:
  - 名前、emailの編集
  - パスワードはInputフォームのみ（現在値は表示しない）

---

## API設計方針

### 基本方針

各テーブルに対するCRUD APIを提供

### エンドポイント例

```
# User
GET    /users/:id
POST   /users
PUT    /users/:id
DELETE /users/:id

# Match
GET    /matches
GET    /matches/:id
POST   /matches
PUT    /matches/:id
DELETE /matches/:id

# Weapon（参照のみ）
GET    /weapons
GET    /weapons/:id

# Stage（参照のみ）
GET    /stages
GET    /stages/:id

# Rule（参照のみ）
GET    /rules
GET    /rules/:id

# BattleType（参照のみ）
GET    /battle-types
GET    /battle-types/:id
```

### 例外

- **UserSecret**: CRUD APIなし（ログイン時の参照のみ）
- **分析画面用**: 独自の集計・分析APIを作成
  - 例: `GET /analytics/win-rate-by-stage`
  - 例: `GET /analytics/rate-history`

---

## 用語集（Glossary）

| 日本語             | 英語           | 説明                                         |
| ------------------ | -------------- | -------------------------------------------- |
| 試合               | Match          | 1回の対戦記録                                |
| ブキ               | Weapon         | メイン・サブ・スペシャルの3点セット          |
| メインウェポン     | Main Weapon    | プレイヤーが選択する主武器                   |
| サブウェポン       | Sub Weapon     | メインに紐づくサブ武器                       |
| スペシャルウェポン | Special Weapon | メインに紐づく必殺技                         |
| ステージ           | Stage          | 試合が行われるマップ                         |
| ルール             | Rule           | ゲームルール                                 |
| 試合方式           | Battle Type    | オープン/チャレンジ/Xマッチ                  |
| レートポイント     | Rate Point     | 試合後の累積レート                           |
| セット             | Set            | チャレンジ/Xマッチにおける複数試合のまとまり |
| 勝敗               | Result         | WIN/LOSEなどの試合結果                       |
| 分析               | Analysis       | 複数のMatchを元にした統計・傾向分析          |

---

## 変更履歴

### 2025-11-23

- 初版作成
- `Analysis`テーブルを`Match`にリネーム（schema.prisma修正、migration作成完了）
- レートポイントの記録方法を明確化（累積レート方式）
